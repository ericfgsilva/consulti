define(["parsley/utils","parsley/defaults","parsley/abstract","parsley/validator","parsley/ui","parsley/factory/options","parsley/form","parsley/field","parsley/multiple","parsley/pubsub","i18n/en"],function(ParsleyUtils,ParsleyDefaults,ParsleyAbstract,ParsleyValidator,ParsleyUI,ParsleyOptionsFactory,ParsleyForm,ParsleyField,ParsleyMultiple){var Parsley=function(element,options,parsleyFormInstance){if(this.__class__="Parsley",this.__version__="@@version",this.__id__=ParsleyUtils.hash(4),"undefined"==typeof element)throw new Error("You must give an element");if("undefined"!=typeof parsleyFormInstance&&"ParsleyForm"!==parsleyFormInstance.__class__)throw new Error("Parent instance must be a ParsleyForm instance");return this.init($(element),options,parsleyFormInstance)};return Parsley.prototype={init:function($element,options,parsleyFormInstance){if(!$element.length)throw new Error("You must bind Parsley on an existing element.");if(this.$element=$element,this.$element.data("Parsley")){var savedparsleyFormInstance=this.$element.data("Parsley");return"undefined"!=typeof parsleyFormInstance&&(savedparsleyFormInstance.parent=parsleyFormInstance),savedparsleyFormInstance}return this.OptionsFactory=new ParsleyOptionsFactory(ParsleyDefaults,ParsleyUtils.get(window,"ParsleyConfig")||{},options,this.getNamespace(options)),this.options=this.OptionsFactory.get(this),this.$element.is("form")||ParsleyUtils.attr(this.$element,this.options.namespace,"validate")&&!this.$element.is(this.options.inputs)?this.bind("parsleyForm"):this.$element.is(this.options.inputs)&&!this.$element.is(this.options.excluded)?this.isMultiple()?this.handleMultiple(parsleyFormInstance):this.bind("parsleyField",parsleyFormInstance):this},isMultiple:function(){return this.$element.is("input[type=radio], input[type=checkbox]")&&"undefined"==typeof this.options.multiple||this.$element.is("select")&&"undefined"!=typeof this.$element.attr("multiple")},handleMultiple:function(parsleyFormInstance){var name,multiple,parsleyMultipleInstance,that=this;if(this.options=$.extend(this.options,parsleyFormInstance?parsleyFormInstance.OptionsFactory.get(parsleyFormInstance):{},ParsleyUtils.attr(this.$element,this.options.namespace)),this.options.multiple?multiple=this.options.multiple:"undefined"!=typeof this.$element.attr("name")&&this.$element.attr("name").length?multiple=name=this.$element.attr("name"):"undefined"!=typeof this.$element.attr("id")&&this.$element.attr("id").length&&(multiple=this.$element.attr("id")),this.$element.is("select")&&"undefined"!=typeof this.$element.attr("multiple"))return this.bind("parsleyFieldMultiple",parsleyFormInstance,multiple||this.__id__);if("undefined"==typeof multiple)return window.console&&window.console.warn&&window.console.warn("To be binded by Parsley, a radio, a checkbox and a multiple select input must have either a name or a multiple option.",this.$element),this;if(multiple=multiple.replace(/(:|\.|\[|\]|\$)/g,""),"undefined"!=typeof name&&$('input[name="'+name+'"]').each(function(){$(this).is("input[type=radio], input[type=checkbox]")&&$(this).attr(that.options.namespace+"multiple",multiple)}),$("["+this.options.namespace+"multiple="+multiple+"]").length)for(var i=0;i<$("["+this.options.namespace+"multiple="+multiple+"]").length;i++)if("undefined"!=typeof $($("["+this.options.namespace+"multiple="+multiple+"]").get(i)).data("Parsley")){parsleyMultipleInstance=$($("["+this.options.namespace+"multiple="+multiple+"]").get(i)).data("Parsley"),this.$element.data("ParsleyFieldMultiple")||(parsleyMultipleInstance.addElement(this.$element),this.$element.attr(this.options.namespace+"id",parsleyMultipleInstance.__id__));break}return this.bind("parsleyField",parsleyFormInstance,multiple,!0),parsleyMultipleInstance||this.bind("parsleyFieldMultiple",parsleyFormInstance,multiple)},getNamespace:function(options){return"undefined"!=typeof this.$element.data("parsleyNamespace")?this.$element.data("parsleyNamespace"):"undefined"!=typeof ParsleyUtils.get(options,"namespace")?options.namespace:"undefined"!=typeof ParsleyUtils.get(window,"ParsleyConfig.namespace")?window.ParsleyConfig.namespace:ParsleyDefaults.namespace},bind:function(type,parentParsleyFormInstance,multiple,doNotStore){var parsleyInstance;switch(type){case"parsleyForm":parsleyInstance=$.extend(new ParsleyForm(this.$element,this.OptionsFactory),new ParsleyAbstract,window.ParsleyExtend)._bindFields();break;case"parsleyField":parsleyInstance=$.extend(new ParsleyField(this.$element,this.OptionsFactory,parentParsleyFormInstance),new ParsleyAbstract,window.ParsleyExtend);break;case"parsleyFieldMultiple":parsleyInstance=$.extend(new ParsleyField(this.$element,this.OptionsFactory,parentParsleyFormInstance),new ParsleyAbstract,new ParsleyMultiple,window.ParsleyExtend)._init(multiple);break;default:throw new Error(type+"is not a supported Parsley type")}return"undefined"!=typeof multiple&&ParsleyUtils.setAttr(this.$element,this.options.namespace,"multiple",multiple),"undefined"!=typeof doNotStore?(this.$element.data("ParsleyFieldMultiple",parsleyInstance),parsleyInstance):(new RegExp("ParsleyF","i").test(parsleyInstance.__class__)&&(this.$element.data("Parsley",parsleyInstance),$.emit("parsley:"+("parsleyForm"===type?"form":"field")+":init",parsleyInstance)),parsleyInstance)}},$.fn.parsley=$.fn.psly=function(options){if(this.length>1){var instances=[];return this.each(function(){instances.push($(this).parsley(options))}),instances}return $(this).length?new Parsley(this,options):void(window.console&&window.console.warn&&window.console.warn("You must bind Parsley on an existing element."))},window.ParsleyUI="function"==typeof ParsleyUtils.get(window,"ParsleyConfig.ParsleyUI")?(new window.ParsleyConfig.ParsleyUI).listen():(new ParsleyUI).listen(),"undefined"==typeof window.ParsleyExtend&&(window.ParsleyExtend={}),"undefined"==typeof window.ParsleyConfig&&(window.ParsleyConfig={}),window.Parsley=window.psly=Parsley,window.ParsleyUtils=ParsleyUtils,window.ParsleyValidator=new ParsleyValidator(window.ParsleyConfig.validators,window.ParsleyConfig.i18n),!1!==ParsleyUtils.get(window,"ParsleyConfig.autoBind")&&$(document).ready(function(){$("[data-parsley-validate]").length&&$("[data-parsley-validate]").parsley()}),Parsley});